<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no;" />
        <script src="js/underscore.js"></script>
        <script src="js/jquery.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var windowTitle = "IRC";
            document.title = windowTitle;
            $(document).ready(function() {
                var socket = io.connect();
                var initText = "";
                var scrollToBottom = function() {
                    $(document).scrollTop($("#allLogs").prop("scrollHeight"));
                };
                socket.on("log", function(data) {
                    var newmsg = false;
                    _.each(data, function (log) {
                        var logDiv;
                        var msg = log.msg;
                        if ($("div[data-logid=" + log.id + "]").length === 0) {
                            logDiv = $("<div>").attr("data-logid", log.id);
                        } else {
                            logDiv = $("div[data-logid=" + log.id + "]");
                        }
                        if (msg.substring(0, 4) === "PING" || msg.substring(0, 4) === "PONG") {
                            logDiv.addClass("pingpong");
                        } else {
                            if (log.type === "sc") {
                                var tokens = msg.split(" ");
                                if (tokens.length > 2) {
                                    var command = tokens[1].toUpperCase();
                                    switch (command) {
                                    case "PRIVMSG":
                                        logDiv.attr("data-rawmsg", log.msg).attr("title", log.msg);
                                        logDiv.addClass("chat");
                                        var msgbody = tokens[tokens.length - 1];
                                        for (var i = 2; i < tokens.length; i++) {
                                            if (tokens[i].charAt(0) === ":") {
                                                msgbody = tokens.slice(i).join(" ").substring(1);
                                                break;
                                            }
                                        }
                                        var talker = tokens[0].substring(1, tokens[0].indexOf('!'));
                                        msg = talker + ": " + msgbody;
                                        newmsg = true;
                                        break;
                                    }
                                }
                            }
                        }
                        logDiv.text(msg).addClass(log.type);
                        $("#allLogs").append(logDiv);
                    });
                    if (newmsg && !$("#typing").is(":focus")) {
                        document.title = windowTitle + " *";
                    }
                    scrollToBottom();
                });
                $("#typing").on("keydown", function(e) {
                    switch (e.keyCode) {
                    case 13:    // RETURN
                        var msg = $("#typing").val();
                        if (msg.charAt(0) === ':') {
                            initText = msg.substring(1);
                        } else {
                            socket.emit("send", msg.trim());
                        }
                        $("#typing").val(initText);
                        e.preventDefault();
                        break;
                    }
                });
                $("#typing").on("focus", function() {
                    document.title = windowTitle;
                });
            });
        </script>
        <style>
            .cs { color: green; }
            .sc { color: lightGray; }
            .log { color: lightGray; }
            .pingpong { display: none; }
            .sc.chat { color: blue; }
            #allLogs {
                width: 100%;
                font-size: 12pt;
                padding-bottom: 20pt;
            }
            #typing {
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100%;
                font-size: 15pt;
                height: 20pt;
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <div id="allLogs"></div>
        <textarea id="typing"></textarea>
    </body>
</html>
